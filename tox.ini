[tox]
envlist = py310, py311, py312, py313, lint, type, coverage, security
isolated_build = True

[testenv]
extras = dev
deps = 
    pytest
    pytest-cov
    pytest-xdist
    numpy
    pandas
    scipy
    scikit-learn
    matplotlib
    seaborn
    statsmodels
commands =
    pytest -n auto {posargs:tests}

[testenv:lint]
description = Run static analysis tools
deps =
    ruff
    deptry
    vulture
commands =
    ruff check .
    deptry . --extend-exclude output --extend-exclude htmlcov --extend-exclude data
    vulture src/

[testenv:type]
description = Run type checking
deps =
    mypy
    types-PyYAML
commands =
    mypy src/ --ignore-missing-imports

[testenv:coverage]
description = Run tests with coverage reporting
extras = dev
deps =
    pytest
    pytest-cov
    pytest-xdist
commands =
    pytest -n auto --cov=src --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=95 {posargs:tests}

[testenv:security]
description = Run security scanning
deps =
    pip-audit
    bandit[toml]
commands =
    pip-audit -r requirements.txt --ignore-vuln PYSEC-2024-123 || true
    bandit -c pyproject.toml -r src/

[testenv:mutation]
description = Run mutation testing
deps =
    mutmut
    pytest
    numpy
    pandas
    scipy
    scikit-learn
    matplotlib
    seaborn
    statsmodels
commands =
    # Run mutation testing on the core logic module first to save time
    mutmut run --paths-to-mutate src/cea_model_core.py --runner "pytest tests/test_core_functions.py"
    # To run on everything (very slow): mutmut run

[testenv:profile]
description = Run profiling tools
deps =
    memray
    viztracer
    numpy
    pandas
    scipy
    scikit-learn
    matplotlib
    seaborn
    statsmodels
commands =
    # Run memray on the main analysis
    python -m memray run -o output/profiling/memray_analysis.bin -m src.main_analysis --output-dir output/profiling
    python -m memray summary output/profiling/memray_analysis.bin
    
    # Run viztracer
    viztracer --output_file output/profiling/viztracer_analysis.json --ignore_c_function --ignore_frozen -m src.main_analysis --output-dir output/profiling

[gh-actions]
python =
    3.10: py310, lint
    3.11: py311
    3.12: py312
    3.13: py313
    3.14: py314
    3.15: py315
